name: OWASP ZAP Baseline Scan

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Чекаут репозитория
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Создаём сеть для контейнеров
      - name: Create Docker network
        run: docker network create zapnet || true

      # 3️⃣ Запуск Juice Shop
      - name: Run Juice Shop
        run: |
          docker run -d --rm --name juice-shop --network zapnet -p 3000:3000 bkimminich/juice-shop

      # 4️⃣ Ждём запуска приложения
      - name: Wait for Juice Shop
        run: sleep 60

      # 5️⃣ Создаём папку для отчёта
      - name: Create report folder
        run: mkdir -p zap-reports

      # 6️⃣ Запуск ZAP baseline scan
      - name: Run ZAP Baseline Scan
        run: |
          docker run --rm --network zapnet \
            -v ${{ github.workspace }}/zap-reports:/zap/wrk \
            zaproxy/zap-stable zap-baseline.py \
            -t http://juice-shop:3000 \
            -r zap_report.html \
            -J zap_report.json \
            -m 3

      # 7️⃣ Загружаем артефакт
      - name: Upload ZAP report artifact
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: zap-reports/zap_report.html

      # 8️⃣ Публикация отчёта в GitHub Pages
      - name: Publish ZAP report to GitHub Pages
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git clone --branch gh-pages https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }} gh-pages
          cp zap-reports/zap_report.html gh-pages/index.html
          cd gh-pages
          git add index.html
          git commit -m "Update ZAP report"
          git push origin gh-pages