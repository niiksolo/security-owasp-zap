name: ZAP Scan

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  zap-scan:
    runs-on: ubuntu-latest
    services:
      juice-shop:
        image: bkimminich/juice-shop:latest
        ports:
          - 3000:3000
        options: > 
          --health-cmd="curl -s http://localhost:3000 || exit 1"
          --health-interval=5s
          --health-timeout=2s
          --health-retries=10

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Prepare reports folder
      run: mkdir -p zap-reports zap-wrk

    - name: Fix permissions for ZAP
      run: |
        sudo chown -R 1000:1000 zap-wrk
        sudo chmod -R 777 zap-wrk

    - name: Pull ZAP Docker image
      run: docker pull zaproxy/zap-stable:latest

    - name: Run ZAP Baseline Scan
      run: |
        docker run --rm \
          --network host \
          -v ${{ github.workspace }}/zap-reports:/zap/reports \
          -v ${{ github.workspace }}/zap-wrk:/zap/wrk \
          zaproxy/zap-stable \
          zap-baseline.py \
          -t http://localhost:3000 \
          -r /zap/reports/zap_report.html \
          -J /zap/reports/zap_report.json \
          -d

    - name: Show HTML report
      run: head -n 200 zap-reports/zap_report.html || true

    - name: Install jq
      run: sudo apt-get update && sudo apt-get install -y jq

    - name: Fail on High/Critical issues
      run: ./security-ci/fail-on-severity.sh

    - name: Upload ZAP reports
      uses: actions/upload-artifact@v4
      with:
        name: zap-reports
        path: zap-reports/